name: Dependency Update

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    name: Update Go Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Add diagnostic logs for update-dependencies job
      run: |
        echo "Runner OS: $(uname -s)"
        echo "Runner Architecture: $(uname -m)"
        echo "Is this act? $(if [ -n "$ACT" ]; then echo 'Yes'; else echo 'No'; fi)"
        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go (act-compatible)
      if: ${{ env.ACT }}
      run: |
        GO_VERSION='1.23'
        ARCH=$(uname -m)
        [ "$ARCH" = "x86_64" ] && ARCH="amd64"
        [ "$ARCH" = "aarch64" ] && ARCH="arm64"
        wget "https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz"
        sudo rm -rf /usr/local/go
        sudo tar -C /usr/local -xzf "go${GO_VERSION}.linux-${ARCH}.tar.gz"
        echo "/usr/local/go/bin" >> $GITHUB_PATH

    - name: Set up Go (using setup-go)
      if: ${{ !env.ACT }}
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Update dependencies
      run: |
        go get -u ./...
        go mod tidy
        go mod verify

    - name: Run tests
      run: go test ./...

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Go dependencies'
        title: 'chore: update Go dependencies'
        body: |
          This PR updates Go dependencies to their latest versions.
          
          Changes:
          - Updated all Go modules to latest versions
          - Ran `go mod tidy` to clean up module files
          - Verified all tests still pass
          
          Auto-generated by GitHub Actions.
        branch: update-dependencies
        delete-branch: true